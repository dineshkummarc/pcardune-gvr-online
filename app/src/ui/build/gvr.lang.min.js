gvr.lang={};gvr.lang.RUNNER_GLOBAL_KEY="$runner";gvr.lang.getRunner=function getRunner(b){b=b||{};var a=b[gvr.lang.RUNNER_GLOBAL_KEY];if(!a){a={notify:function(){}}}return a};gvr.lang.BaseExpression=Class.extend({line:null,name:null,init:function(a,b){this.line=a;this.name=b}});gvr.lang.Expression=gvr.lang.BaseExpression.extend({callable:null,scope:null,init:function(b,a,c){this._super(b,"expr");this.callable=a;this.scope=c},step:function(a){gvr.lang.getRunner(a).notify(this);try{this.callable.call(this.scope);return[]}catch(b){gvr.alert(b.message)}return null}});gvr.lang.newExpression=function(b,a,c){return new gvr.lang.Expression(b,a,c)};gvr.lang.Block=Class.extend({init:function(a){this.name="block";this.expressions=a;this.currentStep=0},step:function(c){var a=[];if(this.currentStep<this.expressions.length){a.push(this);var b=this.expressions[this.currentStep].step(c);this.currentStep++;a=a.concat(b)}else{this.currentStep=0}return a}});gvr.lang.If=gvr.lang.BaseExpression.extend({init:function(b,a,c,d){this._super(b,"if");this.callable=a;this.scope=c;this.block=new gvr.lang.Block(d);this.elifs=[];this.elseBlock=new gvr.lang.Block([])},step:function(d){gvr.lang.getRunner(d).notify(this);var b=false;var a=[];if(this.callable.call(this.scope)){a=this.block.step(d);b=true}else{if(this.elifs.length>0){for(var c=0;c<this.elifs.length;c++){var e=a.length;a=this.elifs[c].step(d);if(e!=a.length){b=true;break}}}}if(!b&&this.elseBlock.expressions.length>0){a=this.elseBlock.step(d)}return a}});gvr.lang.newIf=function(b,a,c,d){return new gvr.lang.If(b,a,c,d)};gvr.lang.While=gvr.lang.BaseExpression.extend({init:function(b,a,c,d){this._super(b,"while");this.callable=a;this.scope=c;this.block=new gvr.lang.Block(d)},step:function(b){gvr.lang.getRunner(b).notify(this);var a=[];if(this.callable.call(this.scope)){a.push(this);a=a.concat(this.block.step(b))}return a}});gvr.lang.newWhile=function(b,a,c,d){return new gvr.lang.While(b,a,c,d)};gvr.lang.Do=gvr.lang.BaseExpression.extend({init:function(a,c,b){this._super(a,"do");this.count=c;this.block=new gvr.lang.Block(b);this.currentStep=0},step:function(b){gvr.lang.getRunner(b).notify(this);var a=[];if(this.currentStep<this.count){a.push(this);this.currentStep++;a=a.concat(this.block.step(b))}else{this.currentStep=0}return a}});gvr.lang.newDo=function(a,c,b){return new gvr.lang.Do(a,c,b)};gvr.lang.Define=gvr.lang.BaseExpression.extend({init:function(a,b,c){this._super(a,b);this.block=new gvr.lang.Block(c)},step:function(a){gvr.lang.getRunner(a).notify(this);a[this.name]=this;return[]}});gvr.lang.newDefine=function(a,b,c){return new gvr.lang.Define(a,b,c)};gvr.lang.FunctionCall=gvr.lang.BaseExpression.extend({init:function(a,b){this._super(a,"call");this.fname=b},step:function(a){gvr.lang.getRunner(a).notify(this);if(!a[this.fname]){throw new Error("The function "+this.fname+" is undefined.")}return a[this.fname].block.step(a)}});gvr.lang.newFunctionCall=function(a,b){return new gvr.lang.FunctionCall(a,b)};