(function(){var a=false,b=/xyz/.test(function(){xyz})?/\b_super\b/:/.*/;this.Class=function(){};Class.extend=function(g){var f=this.prototype;a=true;var e=new this();a=false;for(var d in g){e[d]=typeof g[d]=="function"&&typeof f[d]=="function"&&b.test(g[d])?(function(h,i){return function(){var k=this._super;this._super=f[h];var j=i.apply(this,arguments);this._super=k;return j}})(d,g[d]):g[d]}function c(){if(!a&&this.init){this.init.apply(this,arguments)}}c.prototype=e;c.constructor=c;c.extend=arguments.callee;return c}})();var gvr={};gvr.alert=function(a){alert(a)};gvr.DEBUG=false;gvr.debug=function(){if(gvr.DEBUG){console.log.apply(this,arguments)}};gvr.lang={};gvr.lang.RUNNER_GLOBAL_KEY="$runner";gvr.lang.getRunner=function getRunner(b){b=b||{};var a=b[gvr.lang.RUNNER_GLOBAL_KEY];if(!a){a={notify:function(){}}}return a};gvr.lang.BaseExpression=Class.extend({line:null,name:null,init:function(a,b){this.line=a;this.name=b}});gvr.lang.Expression=gvr.lang.BaseExpression.extend({callable:null,scope:null,init:function(b,a,c){this._super(b,"expr");this.callable=a;this.scope=c},step:function(a){gvr.lang.getRunner(a).notify(this);try{this.callable.call(this.scope);return[]}catch(b){gvr.alert(b.message)}return null}});gvr.lang.newExpression=function(b,a,c){return new gvr.lang.Expression(b,a,c)};gvr.lang.Block=Class.extend({init:function(a){this.name="block";this.expressions=a;this.currentStep=0},step:function(c){var a=[];if(this.currentStep<this.expressions.length){a.push(this);var b=this.expressions[this.currentStep].step(c);this.currentStep++;a=a.concat(b)}else{this.currentStep=0}return a}});gvr.lang.If=gvr.lang.BaseExpression.extend({init:function(b,a,c,d){this._super(b,"if");this.callable=a;this.scope=c;this.block=new gvr.lang.Block(d);this.elifs=[];this.elseBlock=new gvr.lang.Block([])},step:function(d){gvr.lang.getRunner(d).notify(this);var b=false;var a=[];if(this.callable.call(this.scope)){a=this.block.step(d);b=true}else{if(this.elifs.length>0){for(var c=0;c<this.elifs.length;c++){var e=a.length;a=this.elifs[c].step(d);if(e!=a.length){b=true;break}}}}if(!b&&this.elseBlock.expressions.length>0){a=this.elseBlock.step(d)}return a}});gvr.lang.newIf=function(b,a,c,d){return new gvr.lang.If(b,a,c,d)};gvr.lang.While=gvr.lang.BaseExpression.extend({init:function(b,a,c,d){this._super(b,"while");this.callable=a;this.scope=c;this.block=new gvr.lang.Block(d)},step:function(b){gvr.lang.getRunner(b).notify(this);var a=[];if(this.callable.call(this.scope)){a.push(this);a=a.concat(this.block.step(b))}return a}});gvr.lang.newWhile=function(b,a,c,d){return new gvr.lang.While(b,a,c,d)};gvr.lang.Do=gvr.lang.BaseExpression.extend({init:function(a,c,b){this._super(a,"do");this.count=c;this.block=new gvr.lang.Block(b);this.currentStep=0},step:function(b){gvr.lang.getRunner(b).notify(this);var a=[];if(this.currentStep<this.count){a.push(this);this.currentStep++;a=a.concat(this.block.step(b))}else{this.currentStep=0}return a}});gvr.lang.newDo=function(a,c,b){return new gvr.lang.Do(a,c,b)};gvr.lang.Define=gvr.lang.BaseExpression.extend({init:function(a,b,c){this._super(a,b);this.block=new gvr.lang.Block(c)},step:function(a){gvr.lang.getRunner(a).notify(this);a[this.name]=this;return[]}});gvr.lang.newDefine=function(a,b,c){return new gvr.lang.Define(a,b,c)};gvr.lang.FunctionCall=gvr.lang.BaseExpression.extend({init:function(a,b){this._super(a,"call");this.fname=b},step:function(a){gvr.lang.getRunner(a).notify(this);if(!a[this.fname]){throw new Error("The function "+this.fname+" is undefined.")}return a[this.fname].block.step(a)}});gvr.lang.newFunctionCall=function(a,b){return new gvr.lang.FunctionCall(a,b)};gvr.lang.parser={};gvr.lang.parser.EXPRESSION=/^(\w*)\s*$/;gvr.lang.parser.DO=/^do\s*(\d+)\s*:\s*$/;gvr.lang.parser.IF=/^if\s*(\w+)\s*:\s*$/;gvr.lang.parser.ELIF=/^elif\s*(\w+)\s*:\s*$/;gvr.lang.parser.ELSE=/^else\s*:\s*$/;gvr.lang.parser.WHILE=/^while\s*(\w+)\s*:\s*$/;gvr.lang.parser.DEFINE=/^define\s*(\w+)\s*:\s*$/;gvr.lang.parser.EMPTY_LINE=/^\s*$/;gvr.lang.parser.INDENTATION=/^(\s*).*$/;gvr.lang.parser.removeComment=function(a){var b=a.indexOf("#");if(b>=0){a=a.slice(0,b)}return a};gvr.lang.parser.Parser=Class.extend({init:function(a,b){this.lines=a;this.robot=b;this.lineIndex=0},parse:function(){return new gvr.lang.Block(this.parseLines(""))},handlers:[function parseExpression(b,a,c){var e=b.match(gvr.lang.parser.EXPRESSION);if(e){var d=e[1];gvr.debug(a+d);if(d in this.robot){c.push(gvr.lang.newExpression(this.lineIndex,this.robot[d],this.robot))}else{c.push(gvr.lang.newFunctionCall(this.lineIndex,d))}return true}return false},function parseDo(b,a,e){var d=b.match(gvr.lang.parser.DO);if(d){var c=parseInt(d[1],10);gvr.debug(a+"do "+c+":");e.push(gvr.lang.newDo(this.lineIndex,c,this.parseBlock()));return true}return false},function parseIf(b,a,d){var e=b.match(gvr.lang.parser.IF);if(e){var c=e[1];if(c in this.robot){gvr.debug(a+"if "+c+":");d.push(gvr.lang.newIf(this.lineIndex,this.robot[c],this.robot,this.parseBlock()));return true}}return false},function parseElif(b,a,d){var e=b.match(gvr.lang.parser.ELIF);if(e&&d[d.length-1].name==="if"){var c=e[1];gvr.debug(a+"elif "+c+":");d[d.length-1].elifs.push(gvr.lang.newIf(this.lineIndex,this.robot[c],this.robot,this.parseBlock()));return true}return false},function parseElse(b,a,d){var c=b.match(gvr.lang.parser.ELSE);if(c&&d[d.length-1].name==="if"){gvr.debug(a+"else:");d[d.length-1].elseBlock.expressions=this.parseBlock();return true}return false},function parseWhile(b,a,d){var c=b.match(gvr.lang.parser.WHILE);if(c){cond=c[1];if(cond in this.robot){gvr.debug(a+"while "+cond+":");d.push(gvr.lang.newWhile(this.lineIndex,this.robot[cond],this.robot,this.parseBlock()));return true}}return false},function parseDefine(b,a,d){var e=b.match(gvr.lang.parser.DEFINE);if(e){var c=e[1];gvr.debug(a+"define "+c+":");d.push(gvr.lang.newDefine(this.lineIndex,c,this.parseBlock()));return true}return false}],parseLines:function(a){var f=[];for(;this.lineIndex<this.lines.length;this.lineIndex++){var c=gvr.lang.parser.removeComment(this.lines[this.lineIndex]);if(c.indexOf(a)!==0){break}else{c=c.slice(a.length)}if(c.match(gvr.lang.parser.EMPTY_LINE)){continue}var b=false;for(var d=0;d<this.handlers.length;d++){var e=this.handlers[d];if(e.call(this,c,a,f)){b=true;break}}if(!b){throw new Error("Syntax Error on line "+(this.lineIndex+1)+": "+c)}}return f},parseBlock:function(){var c=this.lines[++this.lineIndex];var b=c.match(gvr.lang.parser.INDENTATION)[1];var a=this.parseLines(b);this.lineIndex--;return a}});gvr.lang.parser.newParser=function(a,b){return new gvr.lang.parser.Parser(a,b)};gvr.world={};gvr.world.World=Class.extend({init:function(){this.robot=gvr.newRobot(this);this.walls={};this.beepers={}},setBeepers:function(a,c,b){if(b!==null){this.beepers[""+a+","+c]=b}else{delete this.beepers[""+a+","+c]}},getBeepers:function(a,b){return this.beepers[""+a+","+b]||0},getWallCoordinates:function(a,c,b){if(b===gvr.robot.WEST){b=gvr.robot.EAST;a-=1}else{if(b===gvr.robot.SOUTH){b=gvr.robot.NORTH;c-=1}}return{x:a,y:c,direction:b}},setWall:function(a,g,e,c){var d=this.getWallCoordinates(a,g,e);var b=""+d.x+","+d.y;if(!this.walls[b]){this.walls[b]={NORTH:false,EAST:false}}this.walls[b][d.direction]=true;if(c!==null&&c>1){var f=gvr.robot.OFFSET[e];this.setWall(a+f.y,g+f.x,e,c-1)}},getWall:function(b,e,d){var c=this.getWallCoordinates(b,e,d);var a=this.walls[""+c.x+","+c.y];return(a&&a[c.direction])||(c.x===0&&c.direction===gvr.robot.EAST)||(c.y===0&&c.direction===gvr.robot.NORTH)||false}});gvr.world.parser={};gvr.world.parser.SPEC=/^\s*(\w+)\s+(\d+)\s+(\d+)\s+([NESW])\s+(\d+)?\s*$/;gvr.world.parser.BEEPERS=/^\s*(\w+)\s+(\d+)\s+(\d+)\s+(\d+)\s*$/;gvr.world.parser.EMPTY_LINE=gvr.lang.parser.EMPTY_LINE;gvr.world.parser.Parser=Class.extend({init:function(a,b){this.lines=a;this.world=b},parse:function(){var a,b,d,g;for(var e=0;e<this.lines.length;e++){var j=gvr.lang.parser.removeComment(this.lines[e]);if(j.match(gvr.world.parser.EMPTY_LINE)){continue}var c=j.match(gvr.world.parser.SPEC);if(c){a=c[1].toUpperCase();b=parseInt(c[2],10);d=parseInt(c[3],10);var h={N:"NORTH",S:"SOUTH",E:"EAST",W:"WEST"}[c[4]];g=parseInt(c[5],10)||1;if(a==="ROBOT"){this.world.robot.x=b;this.world.robot.y=d;this.world.robot.beepers=g;this.world.robot.direction=h}if(a==="WALL"){this.world.setWall(b,d,h,g)}}var f=j.match(gvr.world.parser.BEEPERS);if(f){a=f[1].toUpperCase();if(a=="BEEPERS"){b=parseInt(f[2],10);d=parseInt(f[3],10);g=parseInt(f[4],10);this.world.setBeepers(b,d,g)}}}}});gvr.world.parser.newParser=function(a,b){return new gvr.world.parser.Parser(a,b)};var gvr=gvr||{};gvr.web=gvr.web||{};gvr.web.client={};gvr.web.client.Client=Class.extend({init:function(a){this.rootUrl=a||"/api"},logon:function(){window.location=this.rootUrl+"/logon?nextURL="+escape(window.location.href)},logout:function(){window.location=this.rootUrl+"/logout?nextURL="+escape(window.location.href)},post:function(a,b,c){jQuery.ajax({type:"POST",data:b,dataType:"json",url:a,success:c})},getUser:function(a){jQuery.getJSON(this.rootUrl+"/user",a)},getPrograms:function(a){jQuery.getJSON(this.rootUrl+"/programs",a)},getProgram:function(a,b){jQuery.getJSON(this.rootUrl+"/programs/"+a,b)},addProgram:function(a,b){this.post(this.rootUrl+"/programs",a,b)},saveProgram:function(a,b){this.post(this.rootUrl+"/programs/"+a.key,a,b)},deleteProgram:function(a,b){jQuery.get(this.rootUrl+"/delete/"+a.key,b)},getWorlds:function(a){jQuery.getJSON(this.rootUrl+"/worlds",a)},getWorld:function(a,b){jQuery.getJSON(this.rootUrl+"/worlds/"+a,b)},addWorld:function(a,b){this.post(this.rootUrl+"/worlds",a,b)},saveWorld:function(a,b){this.post(this.rootUrl+"/worlds/"+a.key,a,b)},deleteWorld:function(a,b){jQuery.get(this.rootUrl+"/delete/"+a.key,b)},getExamples:function(a){jQuery.getJSON(this.rootUrl+"/examples",a)},getExample:function(a,b){jQuery.getJSON(this.rootUrl+"/examples/"+a,b)},addExample:function(a,b){this.post(this.rootUrl+"/examples",a,b)},saveExample:function(a,b){this.post(a,this.rootUrl+"/examples/"+a.key,b)},deleteExample:function(a,b){jQuery.get(this.rootUrl+"/delete/"+a.key,b)}});gvr.web.client.newClient=function(a){return new gvr.web.client.Client(a)};gvr.renderer={};gvr.renderer.Renderer=Class.extend({init:function(a,b){this.canvas=document.getElementById(a);this.context=this.canvas.getContext("2d");this.world=b;this.startX=1;this.startY=1;this.endX=12;this.endY=12;this.scale=40},getCanvasCoords:function(a,b){return{x:a*this.scale,y:b*this.scale}},renderBounderies:function(){this.context.fillStyle=this.startY===1?"red":"#aaffaa";var a=this.getCanvasCoords(this.startX,this.startY);this.context.fillRect(a.x,a.y,this.canvas.width,2);this.context.fillStyle=this.startX===1?"red":"#aaffaa";a=this.getCanvasCoords(this.startX,this.startY);this.context.fillRect(a.x,a.y,2,this.canvas.height)},renderCorners:function(){this.context.fillStyle="#000000";for(var a=2;a<=this.endX-this.startX+1;a++){for(var c=2;c<=this.endY-this.startY+1;c++){var b=this.getCanvasCoords(a,c);this.context.fillRect(b.x,b.y,4,4)}}},renderRobot:function(){this.context.save();this.context.fillStyle="white";this.context.lineWidth=5;var a=this.getCanvasCoords(this.world.robot.x,this.world.robot.y);this.context.translate(a.x+this.scale/2,a.y+this.scale/2);var c={NORTH:0,WEST:Math.PI/2,SOUTH:Math.PI,EAST:-Math.PI/2}[this.world.robot.direction];this.context.rotate(c);var b=this.scale*0.2;this.context.beginPath();this.context.moveTo(-this.scale/2+b,-this.scale/2+b);this.context.lineTo(this.scale/2-b,-this.scale/2+b);this.context.lineTo(0,this.scale/2-b);this.context.closePath();this.context.stroke();this.context.fill();this.context.restore()},renderCoordinates:function(){this.context.fillStyle="black";var c,b;for(var a=this.startX;a<this.endX;a++){c=this.getCanvasCoords(a,this.startY-1);this.context.save();b=this.context.mozMeasureText(""+a);this.context.translate(c.x+this.scale/2-b/2,c.y+this.scale/2);this.context.scale(1,-1);this.context.mozDrawText(""+a);this.context.restore()}for(var d=this.startY;d<this.endY;d++){c=this.getCanvasCoords(this.startX-1,d);this.context.save();b=this.context.mozMeasureText(""+d);this.context.translate(c.x+this.scale/2-b/2,c.y+this.scale/2-6);this.context.scale(1,-1);this.context.mozDrawText(""+d);this.context.restore()}},renderWalls:function(){this.context.fillStyle="red";for(var a=this.startX;a<this.endX;a++){for(var c=this.startY;c<this.endY;c++){var b=this.getCanvasCoords(a,c);if(this.world.getWall(a,c,gvr.robot.NORTH)){this.context.fillRect(b.x,b.y+this.scale,this.scale,2)}if(this.world.getWall(a,c,gvr.robot.EAST)){this.context.fillRect(b.x+this.scale,b.y,2,this.scale)}}}},renderBeepers:function(){this.context.fillStyle="blue";this.context.strokeStyle="blue";for(var a=this.startX;a<this.endX;a++){for(var f=this.startY;f<this.endY;f++){var d=this.getCanvasCoords(a,f);var e=this.scale*0.2;var b=this.world.getBeepers(a,f);if(b>0){this.context.beginPath();this.context.arc(d.x+this.scale/2,d.y+this.scale/2,this.scale/2-e,0,Math.PI*2,false);this.context.stroke();if(b<2){this.context.beginPath();this.context.arc(d.x+this.scale/2,d.y+this.scale/2,this.scale/2-e-3,0,Math.PI*2,false);this.context.fill()}else{this.context.save();var c=this.context.mozMeasureText(""+b);this.mozTextStyle="10px sans-serif";this.context.translate(d.x+this.scale/2-c/2,d.y+this.scale/2-6);this.context.scale(1,-1);this.context.mozDrawText(""+b);this.context.restore()}}}}},followRobot:function(){var d=this.endX-1;var c=this.endY-1;var b=0;var a=0;if(this.world.robot.x>d){b=this.world.robot.x-d}else{if(this.world.robot.x<this.startX){b=this.world.robot.x-this.startX}}if(this.world.robot.y>c){a=this.world.robot.y-c}else{if(this.world.robot.y<this.startY){a=this.world.robot.y-this.startY}}this.startX+=b;this.endX+=b;this.startY+=a;this.endY+=a},render:function(){this.followRobot();this.context.save();this.context.clearRect(0,0,this.canvas.width,this.canvas.height);this.context.transform(1,0,0,-1,0,this.canvas.height);this.renderCorners();this.context.save();this.context.translate(-(this.startX-1)*this.scale,-(this.startY-1)*this.scale);this.renderBounderies();this.renderWalls();this.renderBeepers();this.renderRobot();this.renderCoordinates();this.context.restore();this.context.restore()}});gvr.robot={};gvr.robot.NORTH="NORTH";gvr.robot.WEST="WEST";gvr.robot.SOUTH="SOUTH";gvr.robot.EAST="EAST";gvr.robot.LEFT_OF={};gvr.robot.LEFT_OF[gvr.robot.NORTH]=gvr.robot.WEST;gvr.robot.LEFT_OF[gvr.robot.WEST]=gvr.robot.SOUTH;gvr.robot.LEFT_OF[gvr.robot.SOUTH]=gvr.robot.EAST;gvr.robot.LEFT_OF[gvr.robot.EAST]=gvr.robot.NORTH;gvr.robot.OFFSET={NORTH:{x:0,y:1},SOUTH:{x:0,y:-1},EAST:{x:1,y:0},WEST:{x:-1,y:0}};gvr.robot.Robot=Class.extend({init:function(a){this.x=1;this.y=1;this.world=a;this.direction=gvr.robot.NORTH;this.beepers=0;this.on=true},move:function move(){if(this.front_is_blocked()){throw new Error("Ran into a wall")}var a=gvr.robot.OFFSET[this.direction];this.x+=a.x;this.y+=a.y},turnleft:function turnleft(){this.direction=gvr.robot.LEFT_OF[this.direction]},pickbeeper:function pickbeeper(){var a=this.world.getBeepers(this.x,this.y);if(a>0){this.beepers+=1;this.world.setBeepers(this.x,this.y,a-1)}else{throw new Error("No beepers to pick up.")}},putbeeper:function putbeeper(){if(this.beepers>0){this.beepers-=1;this.world.setBeepers(this.x,this.y,this.world.getBeepers(this.x,this.y)+1)}else{throw new Error("No beepers in beeper bag.")}},turnoff:function turnoff(){this.on=false;gvr.alert("Robot turned off")},facing_north:function facing_north(){return this.direction===gvr.robot.NORTH},facing_south:function facing_south(){return this.direction===gvr.robot.SOUTH},facing_east:function facing_east(){return this.direction===gvr.robot.EAST},facing_west:function facing_west(){return this.direction===gvr.robot.WEST},any_beepers_in_beeper_bag:function any_beepers_in_beeper_bag(){return this.beepers>0},next_to_a_beeper:function next_to_a_beeper(){return this.world.getBeepers(this.x,this.y)>0},front_is_blocked:function front_is_blocked(){return this.world.getWall(this.x,this.y,this.direction)},left_is_blocked:function left_is_blocked(){return this.world.getWall(this.x,this.y,gvr.robot.LEFT_OF[this.direction])},right_is_blocked:function right_is_blocked(){var a=gvr.robot.LEFT_OF[gvr.robot.LEFT_OF[gvr.robot.LEFT_OF[this.direction]]];return this.world.getWall(this.x,this.y,a)},not_facing_north:function(){return !this.facing_north()},not_facing_south:function(){return !this.facing_south()},not_facing_east:function(){return !this.facing_east()},not_facing_west:function(){return !this.facing_west()},no_beepers_in_beeper_bag:function no_beepers_in_beeper_bag(){return !this.any_beepers_in_beeper_bag()},not_next_to_a_beeper:function not_next_to_a_beeper(){return !this.next_to_a_beeper()},front_is_clear:function front_is_clear(){return !this.front_is_blocked()},left_is_clear:function left_is_clear(){return !this.left_is_blocked()},right_is_clear:function right_is_clear(){return !this.right_is_blocked()}});gvr.runner={Runner:Class.extend({init:function(a,c,b){this.program=a;this.stack=[this.program];this.renderer=c;this.globals={};this.globals[gvr.lang.RUNNER_GLOBAL_KEY]=this;this.timeout=null;this.notify=b||function(d){};this.running=false},printStackTrace:function(){var b=[];for(var a=0;a<this.stack.length;a++){b.push(this.stack[a].name)}return b},step:function(a){this.run(0,a,true)},stop:function(){window.clearTimeout(this.timeout);this.running=false},run:function(g,i,f){this.running=true;var a=g===-1;g=g||200;if(this.stack.length>0){var d=this.stack.pop();try{var b=d.step(this.globals)}catch(h){gvr.alert(h.message);return}this.stack=this.stack.concat(b);if(!a){this.renderer.render()}if(b.length>0){var c=this;if(a){this.run(g,i,f)}else{if(!f){this.timeout=window.setTimeout(function(){c.run(g,i,f)},g)}}}else{this.run(g,i,f)}}else{this.stop();if(this.renderer.world.robot.on){this.stop();gvr.alert("Robot ran out of instructions.")}if(typeof i==="function"){i()}if(a){this.renderer.render()}}}})};gvr.RunTimeError=function(a){this.message=a};gvr.newRobot=function(a){return new gvr.robot.Robot(a)};gvr.newWorld=function(){return new gvr.world.World()};gvr.newRenderer=function(a,b){return new gvr.renderer.Renderer(a,b)};gvr.newRunner=function(a,c,b){return new gvr.runner.Runner(a,c,b)};